/*****************************************************************************
* Copyright 2015-2020 Alexander Barthel alex@littlenavmap.org
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*****************************************************************************/

#include "common/constants.h"

#include "gui/helphandler.h"

#include "options/optiondata.h"
#include "settings/settings.h"

#include <QDir>
#include <QRegularExpression>
#include <QSettings>
#include <QDebug>

namespace lnm {

static QString supportedLanguageOnline;

QString helpOnlineUrl;
QString helpOnlineTutorialsUrl;
QString helpOnlineLegendUrl;
QString helpOnlineInstallRedistUrl;
QString helpOnlineInstallGlobeUrl;
QString helpOnlineNavdatabasesUrl;
QString helpLegendLocalFile;
QString helpOfflineFile;
QString helpDonateUrl;
QString helpFaqUrl;
QString updateDefaultUrl;

/* Generated in void MainWindow::saveStateMain() if DEBUG_CREATE_WINDOW_STATE is defined
 * Used to load window layout on new installations and for reset window layout.*/
const static unsigned char mainWindowState[968] =
{0x0, 0x0, 0x0, 0xff, 0x0, 0x0, 0x0, 0x0, 0xfd, 0x0, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x94, 0x0, 0x0,
 0x2, 0x8c, 0xfc, 0x2, 0x0, 0x0, 0x0, 0x3, 0xfb, 0x0, 0x0, 0x0, 0x1e, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b,
 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65, 0x0, 0x74, 0x0, 0x52, 0x0, 0x6f, 0x0, 0x75, 0x0, 0x74, 0x0,
 0x65, 0x1, 0x0, 0x0, 0x0, 0x63, 0x0, 0x0, 0x0, 0xd6, 0x0, 0x0, 0x0, 0xae, 0x0, 0xff, 0xff, 0xff, 0xfb, 0x0, 0x0,
 0x0, 0x2a, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65, 0x0,
 0x74, 0x0, 0x49, 0x0, 0x6e, 0x0, 0x66, 0x0, 0x6f, 0x0, 0x72, 0x0, 0x6d, 0x0, 0x61, 0x0, 0x74, 0x0, 0x69, 0x0, 0x6f,
 0x0, 0x6e, 0x1, 0x0, 0x0, 0x1, 0x3f, 0x0, 0x0, 0x0, 0xd8, 0x0, 0x0, 0x0, 0x81, 0x0, 0xff, 0xff, 0xff, 0xfb, 0x0,
 0x0, 0x0, 0x24, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65,
 0x0, 0x74, 0x0, 0x41, 0x0, 0x69, 0x0, 0x72, 0x0, 0x63, 0x0, 0x72, 0x0, 0x61, 0x0, 0x66, 0x0, 0x74, 0x1, 0x0, 0x0,
 0x2, 0x1d, 0x0, 0x0, 0x0, 0xd2, 0x0, 0x0, 0x0, 0x81, 0x0, 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x3, 0x4f,
 0x0, 0x0, 0x2, 0x8c, 0xfc, 0x2, 0x0, 0x0, 0x0, 0x2, 0xfc, 0x0, 0x0, 0x0, 0x63, 0x0, 0x0, 0x2, 0x8c, 0x0, 0x0, 0x1,
 0xdb, 0x0, 0xff, 0xff, 0xff, 0xfc, 0x2, 0x0, 0x0, 0x0, 0x2, 0xfc, 0x0, 0x0, 0x0, 0x63, 0x0, 0x0, 0x2, 0x8c, 0x0,
 0x0, 0x1, 0xdb, 0x0, 0xff, 0xff, 0xff, 0xfc, 0x2, 0x0, 0x0, 0x0, 0x2, 0xfc, 0x0, 0x0, 0x0, 0x63, 0x0, 0x0, 0x2,
 0x19, 0x0, 0x0, 0x1, 0x68, 0x0, 0xff, 0xff, 0xff, 0xfc, 0x1, 0x0, 0x0, 0x0, 0x2, 0xfb, 0x0, 0x0, 0x0, 0x1a, 0x0,
 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65, 0x0, 0x74, 0x0, 0x4d,
 0x0, 0x61, 0x0, 0x70, 0x1, 0x0, 0x0, 0x1, 0x9a, 0x0, 0x0, 0x1, 0x30, 0x0, 0x0, 0x0, 0x36, 0x0, 0xff, 0xff, 0xff,
 0xfb, 0x0, 0x0, 0x0, 0x20, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67,
 0x0, 0x65, 0x0, 0x74, 0x0, 0x53, 0x0, 0x65, 0x0, 0x61, 0x0, 0x72, 0x0, 0x63, 0x0, 0x68, 0x1, 0x0, 0x0, 0x2, 0xd0,
 0x0, 0x0, 0x2, 0x19, 0x0, 0x0, 0x2, 0x19, 0x0, 0xff, 0xff, 0xff, 0xfb, 0x0, 0x0, 0x0, 0x22, 0x0, 0x64, 0x0, 0x6f,
 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65, 0x0, 0x74, 0x0, 0x50, 0x0, 0x72, 0x0,
 0x6f, 0x0, 0x66, 0x0, 0x69, 0x0, 0x6c, 0x0, 0x65, 0x1, 0x0, 0x0, 0x2, 0x82, 0x0, 0x0, 0x0, 0x6d, 0x0, 0x0, 0x0,
 0x6d, 0x0, 0xff, 0xff, 0xff, 0xfb, 0x0, 0x0, 0x0, 0x26, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0,
 0x69, 0x0, 0x64, 0x0, 0x67, 0x0, 0x65, 0x0, 0x74, 0x0, 0x45, 0x0, 0x6c, 0x0, 0x65, 0x0, 0x76, 0x0, 0x61, 0x0, 0x74,
 0x0, 0x69, 0x0, 0x6f, 0x0, 0x6e, 0x1, 0x0, 0x0, 0x2, 0xd5, 0x0, 0x0, 0x0, 0x9c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
 0x0, 0xfb, 0x0, 0x0, 0x0, 0x20, 0x0, 0x64, 0x0, 0x6f, 0x0, 0x63, 0x0, 0x6b, 0x0, 0x57, 0x0, 0x69, 0x0, 0x64, 0x0,
 0x67, 0x0, 0x65, 0x0, 0x74, 0x0, 0x4c, 0x0, 0x65, 0x0, 0x67, 0x0, 0x65, 0x0, 0x6e, 0x0, 0x64, 0x2, 0x0, 0x0, 0x2,
 0x44, 0x0, 0x0, 0x0, 0x68, 0x0, 0x0, 0x2, 0x4e, 0x0, 0x0, 0x2, 0xcc, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x8c, 0x0,
 0x0, 0x0, 0x4, 0x0, 0x0, 0x0, 0x4, 0x0, 0x0, 0x0, 0x8, 0x0, 0x0, 0x0, 0x8, 0xfc, 0x0, 0x0, 0x0, 0x3, 0x0, 0x0, 0x0,
 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0x3, 0x0, 0x0, 0x0, 0x16, 0x0, 0x74, 0x0, 0x6f, 0x0,
 0x6f, 0x0, 0x6c, 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0, 0x4d, 0x0, 0x61, 0x0, 0x69, 0x0, 0x6e, 0x1, 0x0, 0x0, 0x0,
 0x0, 0xff, 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x14, 0x0, 0x74, 0x0, 0x6f, 0x0,
 0x6f, 0x0, 0x6c, 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0, 0x4d, 0x0, 0x61, 0x0, 0x70, 0x1, 0x0, 0x0, 0x0, 0x9b, 0xff,
 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x22, 0x0, 0x74, 0x0, 0x6f, 0x0, 0x6f, 0x0,
 0x6c, 0x0, 0x62, 0x0, 0x61, 0x0, 0x72, 0x0, 0x4d, 0x0, 0x61, 0x0, 0x70, 0x0, 0x4f, 0x0, 0x70, 0x0, 0x74, 0x0, 0x69,
 0x0, 0x6f, 0x0, 0x6e, 0x0, 0x73, 0x1, 0x0, 0x0, 0x1, 0xc8, 0xff, 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0x4, 0x0, 0x0, 0x0, 0x18, 0x0, 0x74, 0x0, 0x6f, 0x0, 0x6f, 0x0, 0x6c,
 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0, 0x52, 0x0, 0x6f, 0x0, 0x75, 0x0, 0x74, 0x0, 0x65, 0x1, 0x0, 0x0, 0x0, 0x0,
 0xff, 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x20, 0x0, 0x74, 0x0, 0x6f, 0x0,
 0x6f, 0x0, 0x6c, 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0, 0x41, 0x0, 0x69, 0x0, 0x72, 0x0, 0x73, 0x0, 0x70, 0x0, 0x61,
 0x0, 0x63, 0x0, 0x65, 0x0, 0x73, 0x1, 0x0, 0x0, 0x1, 0xb1, 0xff, 0xff, 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
 0x0, 0x0, 0x0, 0x0, 0x0, 0x32, 0x0, 0x74, 0x0, 0x6f, 0x0, 0x6f, 0x0, 0x6c, 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0,
 0x4d, 0x0, 0x61, 0x0, 0x70, 0x0, 0x54, 0x0, 0x68, 0x0, 0x65, 0x0, 0x6d, 0x0, 0x65, 0x0, 0x50, 0x0, 0x72, 0x0, 0x6f,
 0x0, 0x6a, 0x0, 0x65, 0x0, 0x63, 0x0, 0x74, 0x0, 0x69, 0x0, 0x6f, 0x0, 0x6e, 0x1, 0x0, 0x0, 0x2, 0xa8, 0xff, 0xff,
 0xff, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x16, 0x0, 0x74, 0x0, 0x6f, 0x0, 0x6f, 0x0, 0x6c,
 0x0, 0x42, 0x0, 0x61, 0x0, 0x72, 0x0, 0x56, 0x0, 0x69, 0x0, 0x65, 0x0, 0x77, 0x1, 0x0, 0x0, 0x3, 0x9b, 0x0, 0x0,
 0x0, 0x7e, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};

const QByteArray DEFAULT_MAINWINDOW_STATE(reinterpret_cast<const char *>(mainWindowState), sizeof(mainWindowState));
const QSize DEFAULT_MAINWINDOW_SIZE(1280, 800);

const QString helpLanguageOnline()
{
  const static QRegularExpression INDICATOR_FILE("little-navmap-user-manual-(.+)\\.online",
                                                 QRegularExpression::CaseInsensitiveOption);

  if(supportedLanguageOnline.isEmpty())
  {
    // Get the online indicator file
    QString onlineFlagFile = atools::gui::HelpHandler::getHelpFile(
      QString("help") + QDir::separator() + "little-navmap-user-manual-${LANG}.online",
      OptionData::instance().getLanguage());

    // Extract language from the file
    QRegularExpressionMatch match = INDICATOR_FILE.match(onlineFlagFile);
    if(match.hasMatch() && !match.captured(1).isEmpty())
      supportedLanguageOnline = match.captured(1);

    // Fall back to English
    if(supportedLanguageOnline.isEmpty())
      supportedLanguageOnline = "en";
  }

  return supportedLanguageOnline;
}

void loadHelpUrls()
{
  QString urlsPath = atools::settings::Settings::instance().getOverloadedPath(lnm::URLS_CONFIG);
  qInfo() << Q_FUNC_INFO << "Loading urls.cfg from" << urlsPath;

  QSettings settings(urlsPath, QSettings::IniFormat);

  // [help] - Online help URLs
  QLatin1Literal base("https://www.littlenavmap.org/manuals/littlenavmap/release/2.2/${LANG}/");
  helpOnlineUrl = settings.value("help/base", base).toString();
  helpOnlineTutorialsUrl = settings.value("help/tutorials", base + "TUTORIALS.html").toString();
  helpOnlineLegendUrl = settings.value("help/legend", base + "LEGEND.html").toString();
  helpOnlineInstallRedistUrl = settings.value("help/installredist", base + "INSTALLATION.html#windows").toString();
  helpOnlineInstallGlobeUrl = settings.value("help/installglobe", base + "OPTIONS.html#cache-elevation").toString();
  helpOnlineNavdatabasesUrl = settings.value("help/navdata", base + "NAVDATA.html").toString();

  // [help] - Other URLs
  helpDonateUrl = settings.value("help/donate", "https://www.littlenavmap.org/donate.html").toString();
  helpFaqUrl = settings.value("help/faq", "https://www.littlenavmap.org/littlenavmap-faq.html").toString();

  // [local] - local files
  helpLegendLocalFile = settings.value("local/legend", "help/legend-${LANG}.html").toString();
  helpOfflineFile = settings.value("local/help", "help/little-navmap-user-manual-${LANG}.pdf").toString();

  // [update] - Update control file
  updateDefaultUrl = settings.value("update/url", "https://www.littlenavmap.org/littlenavmap-version").toString();
}

} // namespace lnm
